<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NETRUNNER // MONITOR</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --c-bg: #03060d;
      --c-panel: #0b111a;
      --c-panel-border: #1c2b3e;
      
      --c-cyan: #00f0ff;
      --c-pink: #ff003c;
      --c-yellow: #fcee0a;
      --c-dim: #455669;
      --c-text: #e0f2ff;

      --font-ui: 'Chakra Petch', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--c-bg);
      background-image: 
        linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      color: var(--c-text);
      font-family: var(--font-ui);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* HEADER */
    header {
      padding: 20px 30px;
      border-bottom: 1px solid var(--c-panel-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(3, 6, 13, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--c-cyan);
      text-shadow: 0 0 15px rgba(0,240,255, 0.4);
    }

    .status-badge {
      font-family: var(--font-code);
      font-size: 12px;
      background: rgba(0, 240, 255, 0.1);
      border: 1px solid var(--c-cyan);
      padding: 5px 12px;
      border-radius: 2px;
      color: var(--c-cyan);
    }
    .status-badge.offline { border-color: var(--c-pink); color: var(--c-pink); background: rgba(255,0,60,0.1); }

    /* LAYOUT */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      flex-grow: 1;
    }

    /* CARDS */
    .card {
      background: var(--c-panel);
      border: 1px solid var(--c-panel-border);
      padding: 0;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* Decorative corners */
    .card::before {
      content: ''; position: absolute; top: -1px; left: -1px;
      width: 10px; height: 10px;
      border-top: 2px solid var(--c-cyan); border-left: 2px solid var(--c-cyan);
    }
    .card::after {
      content: ''; position: absolute; bottom: -1px; right: -1px;
      width: 10px; height: 10px;
      border-bottom: 2px solid var(--c-cyan); border-right: 2px solid var(--c-cyan);
    }

    .card-head {
      padding: 15px 20px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid var(--c-panel-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 14px;
      display: flex;
      flex-direction: column;
    }
    .hw-name {
      font-size: 11px;
      color: var(--c-dim);
      font-family: var(--font-code);
      margin-top: 2px;
    }

    .card-body {
      padding: 20px;
      flex-grow: 1;
    }

    /* METRICS */
    .big-stat {
      font-size: 48px;
      font-weight: 700;
      font-family: var(--font-code);
      line-height: 1;
      margin-bottom: 10px;
    }
    .cpu-color { color: var(--c-cyan); text-shadow: 0 0 10px rgba(0,240,255,0.3); }
    .gpu-color { color: var(--c-pink); text-shadow: 0 0 10px rgba(255,0,60,0.3); }
    .ram-color { color: var(--c-yellow); text-shadow: 0 0 10px rgba(252,238,10,0.3); }

    .sub-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .data-point {
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-left: 2px solid var(--c-dim);
    }
    .data-point span { display: block; }
    .dp-label { font-size: 10px; color: var(--c-dim); text-transform: uppercase; margin-bottom: 3px; }
    .dp-val { font-family: var(--font-code); font-size: 13px; }

    /* CHARTS */
    .chart-container {
      height: 120px;
      width: 100%;
      margin-top: 15px;
      position: relative;
    }

    /* RAM BAR */
    .ram-track {
      height: 20px;
      background: #111;
      border: 1px solid var(--c-panel-border);
      margin-top: 10px;
      display: flex;
      gap: 2px;
      padding: 2px;
    }
    .ram-seg {
      flex-grow: 1;
      background: var(--c-dim);
      opacity: 0.2;
      transition: opacity 0.2s, background 0.2s;
    }
    .ram-seg.active {
      opacity: 1;
      background: var(--c-yellow);
      box-shadow: 0 0 5px var(--c-yellow);
    }

    /* RAW LOG */
    .terminal {
      width: 100%;
      height: 100%;
      background: #000;
      font-family: var(--font-code);
      font-size: 12px;
      color: #0f0;
      padding: 10px;
      border: 1px solid #333;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    @media(max-width: 800px) {
      .container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <header>
    <h1>SYS // MONITOR_v2</h1>
    <div id="connStatus" class="status-badge">INITIALIZING...</div>
  </header>

  <div class="container">
    
    <!-- CPU CARD -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <span>Processing Unit</span>
          <span class="hw-name" id="name_cpu">Scanning...</span>
        </div>
        <div style="color:var(--c-cyan)">:: CPU</div>
      </div>
      <div class="card-body">
        <div class="big-stat cpu-color" id="val_cpu_use">0%</div>
        
        <div class="sub-grid">
          <div class="data-point" style="border-color:var(--c-cyan)">
            <span class="dp-label">CLOCK</span>
            <span class="dp-val" id="val_cpu_clk">--</span>
          </div>
          <div class="data-point" style="border-color:var(--c-cyan)">
            <span class="dp-label">POWER</span>
            <span class="dp-val" id="val_cpu_pwr">--</span>
          </div>
          <div class="data-point" style="border-color:var(--c-cyan)">
            <span class="dp-label">TEMP</span>
            <span class="dp-val" id="val_cpu_tmp">--</span>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="cpuChart"></canvas>
        </div>
      </div>
    </div>

    <!-- GPU CARD -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <span>Graphics Unit</span>
          <span class="hw-name" id="name_gpu">Scanning...</span>
        </div>
        <div style="color:var(--c-pink)">:: GPU</div>
      </div>
      <div class="card-body">
        <div class="big-stat gpu-color" id="val_gpu_use">0%</div>

        <div class="sub-grid">
          <div class="data-point" style="border-color:var(--c-pink)">
            <span class="dp-label">CLOCK</span>
            <span class="dp-val" id="val_gpu_clk">--</span>
          </div>
          <div class="data-point" style="border-color:var(--c-pink)">
            <span class="dp-label">POWER</span>
            <span class="dp-val" id="val_gpu_pwr">--</span>
          </div>
          <div class="data-point" style="border-color:var(--c-pink)">
            <span class="dp-label">TEMP</span>
            <span class="dp-val" id="val_gpu_tmp">--</span>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="gpuChart"></canvas>
        </div>
      </div>
    </div>

    <!-- RAM CARD -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <span>Memory Bank</span>
          <span class="hw-name" id="name_ram">DDR-UNK</span>
        </div>
        <div style="color:var(--c-yellow)">:: RAM</div>
      </div>
      <div class="card-body">
        <div class="big-stat ram-color" id="val_ram_pct">0%</div>
        
        <div class="sub-grid" style="grid-template-columns: 1fr 1fr;">
          <div class="data-point" style="border-color:var(--c-yellow)">
            <span class="dp-label">USED</span>
            <span class="dp-val" id="val_ram_used">-- GB</span>
          </div>
          <div class="data-point" style="border-color:var(--c-yellow)">
            <span class="dp-label">TOTAL</span>
            <span class="dp-val" id="val_ram_tot">-- GB</span>
          </div>
        </div>

        <div style="margin-top:20px;">
          <div class="dp-label">ALLOCATION VISUALIZER</div>
          <div class="ram-track" id="ramSegments">
            <!-- JS generates segments here -->
          </div>
        </div>
      </div>
    </div>

    <!-- RAW LOG CARD -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">Data Stream</div>
      </div>
      <div class="card-body" style="padding:0;">
        <div class="terminal" id="raw_out">Waiting...</div>
      </div>
    </div>

  </div>

<script>
// --- CHART CONFIGURATION ---
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  animation: { duration: 0 }, // Disable animation for instant updates
  plugins: { legend: { display: false } },
  scales: {
    x: { display: false },
    y: { 
      display: true, 
      min: 0, 
      max: 100, 
      grid: { color: '#1c2b3e' },
      ticks: { color: '#455669', font: {family: 'JetBrains Mono', size: 9} }
    }
  },
  elements: {
    line: { tension: 0.3, borderWidth: 2, fill: true },
    point: { radius: 0 }
  }
};

// Create CPU Chart
const ctxCpu = document.getElementById('cpuChart').getContext('2d');
const cpuChart = new Chart(ctxCpu, {
  type: 'line',
  data: {
    labels: Array(30).fill(''),
    datasets: [{
      data: Array(30).fill(0),
      borderColor: '#00f0ff',
      backgroundColor: 'rgba(0, 240, 255, 0.1)',
    }]
  },
  options: chartOptions
});

// Create GPU Chart
const ctxGpu = document.getElementById('gpuChart').getContext('2d');
const gpuChart = new Chart(ctxGpu, {
  type: 'line',
  data: {
    labels: Array(30).fill(''),
    datasets: [{
      data: Array(30).fill(0),
      borderColor: '#ff003c',
      backgroundColor: 'rgba(255, 0, 60, 0.1)',
    }]
  },
  options: chartOptions
});

// Create RAM Segments
const ramContainer = document.getElementById('ramSegments');
for(let i=0; i<20; i++) {
  const d = document.createElement('div');
  d.className = 'ram-seg';
  ramContainer.appendChild(d);
}

// --- LOGIC ---
const refreshMs = 1000;

async function updateDashboard(){
  try {
    const r = await fetch("/stats");
    const j = await r.json();

    // STATUS
    const statusEl = document.getElementById("connStatus");
    statusEl.textContent = "SYSTEM ONLINE";
    statusEl.classList.remove("offline");

    // --- CPU ---
    const cpu = j.cpu || {};
    const cpuU = cpu.usage || 0;
    document.getElementById("val_cpu_use").textContent = cpuU.toFixed(1) + "%";
    document.getElementById("val_cpu_clk").textContent = (cpu.clock || 0).toFixed(0) + " MHz";
    document.getElementById("val_cpu_pwr").textContent = (cpu.power || 0).toFixed(1) + " W";
    document.getElementById("val_cpu_tmp").textContent = (cpu.temp || 0).toFixed(1) + " °C";
    
    // Update CPU Graph
    cpuChart.data.datasets[0].data.push(cpuU);
    cpuChart.data.datasets[0].data.shift();
    cpuChart.update();

    // --- GPU ---
    const gpu = j.gpu || {};
    const gpuU = gpu.usage || 0;
    document.getElementById("val_gpu_use").textContent = gpuU.toFixed(1) + "%";
    document.getElementById("val_gpu_clk").textContent = (gpu.clock || 0).toFixed(0) + " MHz";
    document.getElementById("val_gpu_pwr").textContent = (gpu.power || 0).toFixed(1) + " W";
    document.getElementById("val_gpu_tmp").textContent = (gpu.temp || 0).toFixed(1) + " °C";

    // Update GPU Graph
    gpuChart.data.datasets[0].data.push(gpuU);
    gpuChart.data.datasets[0].data.shift();
    gpuChart.update();

    // --- RAM ---
    const ram = j.ram || {};
    const ramP = ram.usage_percent || 0;
    document.getElementById("val_ram_pct").textContent = ramP.toFixed(1) + "%";
    document.getElementById("val_ram_used").textContent = (ram.used_gb || 0).toFixed(1) + " GB";
    document.getElementById("val_ram_tot").textContent = (ram.total_gb || 0).toFixed(1) + " GB";

    // Update RAM Visual
    const segs = document.querySelectorAll('.ram-seg');
    const activeCount = Math.floor((ramP / 100) * 20);
    segs.forEach((seg, i) => {
      if(i < activeCount) seg.classList.add('active');
      else seg.classList.remove('active');
    });

    // --- INFO & RAW ---
    if(j.info) {
      document.getElementById("name_cpu").textContent = j.info.cpu_name;
      document.getElementById("name_gpu").textContent = j.info.gpu_name;
      document.getElementById("name_ram").textContent = j.info.ram_type || "DDR-UNK";
    }
    document.getElementById("raw_out").textContent = JSON.stringify(j.raw || j, null, 2);

  } catch(e) {
    console.error(e);
    const statusEl = document.getElementById("connStatus");
    statusEl.textContent = "CONNECTION LOST";
    statusEl.classList.add("offline");
  } finally {
    setTimeout(updateDashboard, refreshMs);
  }
}

updateDashboard();
</script>
</body>
</html>